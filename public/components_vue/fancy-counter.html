
<main>
  <h3>Counter: <span u-if="name">{{ name }}</span>
  </h3>

  <section>
    <button @click="count--">(-)<sub>1</sub></button>
    <button @click="count++">(+)<sub>1</sub></button>
    <button @click="incRef($data)">(+)<sub>2</sub></button>
    <div>Property: {{ count }}</div>
  </section>
  <section>
    <button @click="$me.$data.local--">(-)<sub>1</sub></button>
    <button @click="local++">(+)<sub>1</sub></button>
    <button @click="incLocal">(+)<sub>2</sub></button>
    <div>Local: {{ local }}</div>
  </section>
  <section>
    <button @click="sync--">(-)<sub>1</sub></button>
    <button @click="$data.sync--">(-)<sub>2</sub></button>
    <button @click="$me.$data.sync++">(+)<sub>1</sub></button>
    <button @click="incShare()">(+)<sub>2</sub></button>
    <div>Syncronized: {{ sync }}</div>
  </section>
  <section>
    <button @click="persist--">-</button>
    <button @click="persist++">+</button>
    <div>Persistent: {{ persist }}</div>
  </section>
</main>

<script>
  export function $props() {
    return {
      name: '',
      count: {
        default: 0,
        cast: parseInt,
      },
    }
  }

  export function $store({persist, sync}) {
    return {
      local: 0,
      persist: persist(0),
      sync: sync(0),
    }
  }

  class CountEvent extends Event {
    constructor(count) {
      super('count')
      this.count = count
    }
  }

  export default class extends HTMLElement {
    incLocal() { this.$data.local++ }
    incRef(base) { base.count++ }
    incShare() { this.$data.sync += 1}

    async connectedCallback() {
      this.$effect(async () => {
        // Save the next value and trigger the proxy as soon as possible.
        const count = this.$data.count
        // Wait for petite-vue to update the templates and to avoid incomprehensible timing problems.
        // This can be done in the receiving component of an event, but that is impolite.
        await this.$nextTick()
        // Custom event classes have better ergonomics on the receiving end.
        this.dispatchEvent(new CountEvent(count))
      })
    }
  }
</script>

<style>
  main {
    display: inline-block;
    padding: 0 8px 4px 8px;
    border-width: 1px;
    width: 24rem;
    border-style: solid;
    border-color: black;
    font-family: monospace;
    & > h3 > span {
      color: green;
    }
  }
  section {
    font-size: 1.0rem;
    margin-bottom: 0.8rem;

    & > div {
      float: right;
      text-align: right;

      & > div {
        float: right;
        width: 3rem;
      }
    }
  }
</style>
